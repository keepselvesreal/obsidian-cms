#!/bin/bash

# ============================================================
# Link Remover Library
# 마크다운에서 [[...]] 링크를 제거합니다.
# ============================================================

set -euo pipefail

# ============================================================
# 함수: 마크다운 파일의 본문에서만 [[...]] 링크 제거
# 프론트매터(---로 둘러싼 부분)는 유지합니다.
# 입력: $1 = 파일 경로
# 처리: 파일을 직접 수정합니다.
# ============================================================
remove_obsidian_links() {
  local file="$1"

  if [ ! -f "$file" ]; then
    return 1
  fi

  # 프론트매터 끝 위치를 찾아서 본문만 처리
  local temp_file="${file}.tmp"
  local frontmatter_lines=0

  # 프론트매터 끝 위치 찾기 (첫 라인은 ---, 두 번째 ---까지가 프론트매터)
  frontmatter_lines=$(awk '/^---$/{count++; if(count==2){print NR; exit}}' "$file")

  if [ -z "$frontmatter_lines" ]; then
    # 프론트매터가 없으면 본문 링크 제거 (앵커 링크는 유지)
    # [[#...]] 앵커 링크는 유지, [[...]] 파일 링크만 제거
    perl -pe 's/\[\[(?!#)[^\]]*\]\]//g' "$file" > "$temp_file"
  else
    # 프론트매터 복사 + 본문 링크 제거 (앵커 링크는 유지)
    head -n "$frontmatter_lines" "$file" > "$temp_file"
    tail -n +"$((frontmatter_lines + 1))" "$file" | perl -pe 's/\[\[(?!#)[^\]]*\]\]//g' >> "$temp_file"
  fi

  mv "$temp_file" "$file"
  return 0
}

# ============================================================
# 함수: 마크다운 파일의 링크 제거 여부 확인
# 입력: $1 = 파일 경로
# 출력: 0 = 링크 있음, 1 = 링크 없음
# ============================================================
has_obsidian_links() {
  local file="$1"

  if [ ! -f "$file" ]; then
    return 1
  fi

  # [[...]] 패턴이 있는지 확인 (한글 지원)
  grep -q '\[\[' "$file" 2>/dev/null
}

# ============================================================
# 함수: 마크다운 파일에서 링크 제거 (백업 생성)
# 입력: $1 = 파일 경로
# 처리: 원본 파일을 수정하고 .backup 파일 생성
# ============================================================
remove_obsidian_links_with_backup() {
  local file="$1"

  if [ ! -f "$file" ]; then
    return 1
  fi

  # 백업 파일 생성
  cp "$file" "${file}.backup"

  # 링크 제거
  remove_obsidian_links "$file"

  return 0
}

# ============================================================
# 함수: 링크만 추출 (제거 전 확인용)
# 입력: $1 = 파일 경로
# 출력: 발견된 모든 [[...]] 링크
# ============================================================
extract_all_obsidian_links() {
  local file="$1"

  if [ ! -f "$file" ]; then
    return 1
  fi

  # [[...]] 패턴 모두 추출
  grep -oP '\[\[\K[^\]]+(?=\]\])' "$file" 2>/dev/null || true
}
