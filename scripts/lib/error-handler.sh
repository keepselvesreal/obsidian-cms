#!/bin/bash

# ============================================================
# Error Handler Library
# 에러 처리를 통일합니다
# ============================================================

# ============================================================
# 함수: 에러 핸들링
# 입력: $1 = 에러 코드, $2 = 에러 메시지, $3 = 컨텍스트 (선택사항)
# ============================================================
handle_error() {
  local code=${1:-1}
  local msg="$2"
  local context="${3:-}"

  log_error "$msg"
  [ -n "$context" ] && log_info "Context: $context"

  exit "$code"
}

# ============================================================
# 함수: 에러 트랩 설정
# 입력: (없음)
# 용도: set -E와 함께 사용하여 모든 에러 캡처
# ============================================================
setup_error_trap() {
  trap 'handle_trap_error $? $LINENO' ERR
}

# ============================================================
# 함수: 트랩 에러 핸들러
# 입력: $1 = exit code, $2 = line number
# ============================================================
handle_trap_error() {
  local exit_code=$1
  local line_number=$2

  log_error "Error at line $line_number (exit code: $exit_code)"
}

# ============================================================
# 함수: 검증 실패 처리
# 입력: $1 = 조건, $2 = 에러 메시지
# 출력: 조건이 false면 에러 출력 후 종료
# ============================================================
assert() {
  local condition="$1"
  local msg="$2"

  if ! eval "$condition"; then
    handle_error 1 "$msg"
  fi
}

# ============================================================
# 함수: 파일 존재 확인
# 입력: $1 = 파일 경로
# 출력: 0 = 존재, 1 = 미존재
# ============================================================
require_file() {
  local file="$1"

  if [ ! -f "$file" ]; then
    log_error "Required file not found: $file"
    return 1
  fi

  return 0
}

# ============================================================
# 함수: 폴더 존재 확인
# 입력: $1 = 폴더 경로
# 출력: 0 = 존재, 1 = 미존재
# ============================================================
require_dir() {
  local dir="$1"

  if [ ! -d "$dir" ]; then
    log_error "Required directory not found: $dir"
    return 1
  fi

  return 0
}

# ============================================================
# 함수: 명령어 존재 확인
# 입력: $1 = 명령어명
# 출력: 0 = 존재, 1 = 미존재
# ============================================================
require_command() {
  local cmd="$1"

  if ! command -v "$cmd" &> /dev/null; then
    log_error "Required command not found: $cmd"
    return 1
  fi

  return 0
}

# ============================================================
# 함수: 변수 존재 확인
# 입력: $1 = 변수명
# 출력: 0 = 존재, 1 = 미존재
# ============================================================
require_var() {
  local var_name="$1"
  local var_value="${!var_name:-}"

  if [ -z "$var_value" ]; then
    log_error "Required variable not set: $var_name"
    return 1
  fi

  return 0
}

# ============================================================
# 함수: 정리 작업 등록
# 입력: $1 = 정리할 파일/디렉토리 경로
# 용도: 스크립트 종료 시 자동 정리
# ============================================================
cleanup_on_exit() {
  local path="$1"
  trap "rm -rf '$path'" EXIT
}
